#!/usr/bin/env python3
# =============================================================================
#  MiFlasher v2.0 — Advanced Xiaomi Flash & Unlock Toolkit
#  Author: MiFlasher Project | License: MIT
# =============================================================================

import sys
import os
import argparse

# Ensure the project root is in Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core.banner import print_banner
from core.logger import Logger
from core.session import Session

log = Logger()

def build_parser():
    parser = argparse.ArgumentParser(
        prog="miflasher",
        description="MiFlasher v2.0 — Advanced Xiaomi Flash & Unlock Toolkit",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  miflasher device                          Show connected device info
  miflasher device --watch                  Monitor device in real-time
  miflasher unlock                          Unlock bootloader
  miflasher unlock --force                  Force unlock (skip confirmation)
  miflasher flash rom --path rom.zip        Flash ROM from local file
  miflasher flash rom --url https://...     Flash ROM from URL
  miflasher flash boot --path boot.img      Flash boot image
  miflasher flash payload --path payload.bin Flash via payload.bin
  miflasher flash vbmeta --path vbmeta.img  Flash vbmeta
  miflasher backup --all                    Full backup of all partitions
  miflasher backup --partition boot         Backup specific partition
  miflasher restore --path backup.tar       Restore from backup
  miflasher wipe --data                     Wipe data partition
  miflasher wipe --cache                    Wipe cache partition
  miflasher logs                            View recent session logs
  miflasher gui                             Launch web GUI dashboard
  miflasher config --set theme=dark         Set config value
  miflasher config --show                   Show current config
        """
    )
    parser.add_argument("--version", action="version", version="MiFlasher v2.0.0")
    parser.add_argument("--verbose", "-v", action="store_true", help="Enable verbose/debug output")
    parser.add_argument("--no-color", action="store_true", help="Disable colored output")
    parser.add_argument("--log-file", metavar="FILE", help="Save log to file")

    sub = parser.add_subparsers(dest="command", metavar="<command>")

    # ── device ──────────────────────────────────────────────────────────────
    p_dev = sub.add_parser("device", help="Detect and show device information")
    p_dev.add_argument("--watch", action="store_true", help="Watch for device connection changes")
    p_dev.add_argument("--json", action="store_true", help="Output as JSON")
    p_dev.add_argument("--reboot", choices=["system","bootloader","recovery","fastbootd","edl"],
                       help="Reboot device to specified mode")

    # ── unlock ───────────────────────────────────────────────────────────────
    p_ul = sub.add_parser("unlock", help="Unlock bootloader via Mi Unlock")
    p_ul.add_argument("--force", action="store_true", help="Skip confirmation prompt")
    p_ul.add_argument("--token", metavar="TOKEN", help="Use pre-saved unlock token")
    p_ul.add_argument("--fastboot-only", action="store_true", help="Skip Mi Account — USB fastboot unlock only")

    # ── flash ────────────────────────────────────────────────────────────────
    p_fl = sub.add_parser("flash", help="Flash images/ROMs to device")
    fl_sub = p_fl.add_subparsers(dest="flash_target", metavar="<target>")

    def add_flash_parser(name, help_text, extra=None):
        p = fl_sub.add_parser(name, help=help_text)
        src = p.add_mutually_exclusive_group(required=True)
        src.add_argument("--path", metavar="FILE", help="Local file path")
        src.add_argument("--url", metavar="URL", help="Download from URL")
        p.add_argument("--slot", choices=["a","b","all"], default="all",
                       help="Target slot for A/B devices (default: all)")
        p.add_argument("--skip-verify", action="store_true", help="Skip checksum verification")
        p.add_argument("--no-reboot", action="store_true", help="Do not reboot after flash")
        p.add_argument("--wipe-data", action="store_true", help="Wipe data after flash")
        if extra:
            extra(p)
        return p

    def rom_extra(p):
        p.add_argument("--method", choices=["fastboot","adb","script"],
                       default="auto", help="Flash method (default: auto-detect)")
        p.add_argument("--keep-data", action="store_true", help="Use flash_all_except_data_storage.sh")

    add_flash_parser("rom",     "Flash full ROM package (.zip or .tgz)", extra=rom_extra)
    add_flash_parser("boot",    "Flash boot image (boot.img)")
    add_flash_parser("payload", "Flash via payload.bin (OTA package)")
    add_flash_parser("vbmeta",  "Flash vbmeta image")
    add_flash_parser("recovery","Flash recovery image")
    add_flash_parser("super",   "Flash super/dynamic partition image")

    # ── backup ───────────────────────────────────────────────────────────────
    p_bk = sub.add_parser("backup", help="Backup partitions")
    bk_grp = p_bk.add_mutually_exclusive_group(required=True)
    bk_grp.add_argument("--all", action="store_true", help="Backup all partitions")
    bk_grp.add_argument("--partition", metavar="NAME", nargs="+",
                        help="Backup specific partition(s)")
    p_bk.add_argument("--out", metavar="DIR", default="/sdcard/MiFlasher/backups",
                      help="Output directory")
    p_bk.add_argument("--compress", action="store_true", help="Compress backup with gzip")

    # ── restore ──────────────────────────────────────────────────────────────
    p_rs = sub.add_parser("restore", help="Restore from backup")
    p_rs.add_argument("--path", required=True, metavar="FILE", help="Backup archive path")
    p_rs.add_argument("--partition", metavar="NAME", nargs="*",
                      help="Only restore specific partitions")

    # ── wipe ─────────────────────────────────────────────────────────────────
    p_wipe = sub.add_parser("wipe", help="Wipe partitions")
    p_wipe.add_argument("--data",     action="store_true", help="Wipe /data")
    p_wipe.add_argument("--cache",    action="store_true", help="Wipe /cache")
    p_wipe.add_argument("--dalvik",   action="store_true", help="Wipe dalvik/ART cache")
    p_wipe.add_argument("--all",      action="store_true", help="Wipe data + cache + dalvik")
    p_wipe.add_argument("--force",    action="store_true", help="Skip confirmation")

    # ── logs ─────────────────────────────────────────────────────────────────
    p_logs = sub.add_parser("logs", help="View session logs")
    p_logs.add_argument("--tail", metavar="N", type=int, default=50,
                        help="Show last N lines (default: 50)")
    p_logs.add_argument("--session", metavar="ID", help="Show specific session log")
    p_logs.add_argument("--list", action="store_true", help="List all saved sessions")
    p_logs.add_argument("--clear", action="store_true", help="Clear all logs")

    # ── gui ──────────────────────────────────────────────────────────────────
    p_gui = sub.add_parser("gui", help="Launch web GUI dashboard")
    p_gui.add_argument("--port", type=int, default=8080, help="Port (default: 8080)")
    p_gui.add_argument("--host", default="localhost", help="Host (default: localhost)")
    p_gui.add_argument("--no-browser", action="store_true", help="Don't auto-open browser")

    # ── config ───────────────────────────────────────────────────────────────
    p_cfg = sub.add_parser("config", help="Manage MiFlasher configuration")
    p_cfg.add_argument("--set", metavar="KEY=VALUE", nargs="+", help="Set config value(s)")
    p_cfg.add_argument("--get", metavar="KEY", help="Get config value")
    p_cfg.add_argument("--show", action="store_true", help="Show all config")
    p_cfg.add_argument("--reset", action="store_true", help="Reset to defaults")

    return parser


def main():
    parser = build_parser()
    args = parser.parse_args()

    # Init logger
    log.verbose = getattr(args, "verbose", False)
    log.no_color = getattr(args, "no_color", False)
    if getattr(args, "log_file", None):
        log.set_file(args.log_file)

    # Print banner
    print_banner()

    if not args.command:
        parser.print_help()
        sys.exit(0)

    # Init session
    session = Session(log)

    # ── Route commands ────────────────────────────────────────────────────────
    if args.command == "device":
        from core.device import DeviceManager
        dm = DeviceManager(log)
        if args.reboot:
            dm.reboot(args.reboot)
        elif args.watch:
            dm.watch()
        elif args.json:
            dm.show_info(json_output=True)
        else:
            dm.show_info()

    elif args.command == "unlock":
        from core.unlock import UnlockManager
        um = UnlockManager(log)
        um.unlock(force=args.force, token=getattr(args, "token", None), fastboot_only=getattr(args, "fastboot_only", False))

    elif args.command == "flash":
        if not args.flash_target:
            print("  Usage: miflasher flash <rom|boot|payload|vbmeta|recovery|super> [options]")
            sys.exit(1)
        from core.flash import FlashManager
        fm = FlashManager(log)
        src = args.path if args.path else args.url
        is_url = bool(args.url)
        opts = {
            "slot": getattr(args, "slot", "all"),
            "skip_verify": getattr(args, "skip_verify", False),
            "no_reboot": getattr(args, "no_reboot", False),
            "wipe_data": getattr(args, "wipe_data", False),
        }
        fm.flash(target=args.flash_target, source=src, is_url=is_url, **opts)

    elif args.command == "backup":
        from core.backup import BackupManager
        bm = BackupManager(log)
        partitions = None if args.all else args.partition
        bm.backup(partitions=partitions, out_dir=args.out, compress=args.compress)

    elif args.command == "restore":
        from core.backup import BackupManager
        bm = BackupManager(log)
        bm.restore(path=args.path, partitions=getattr(args, "partition", None))

    elif args.command == "wipe":
        from core.wipe import WipeManager
        wm = WipeManager(log)
        wm.wipe(
            data=args.data or args.all,
            cache=args.cache or args.all,
            dalvik=args.dalvik or args.all,
            force=args.force
        )

    elif args.command == "logs":
        from core.session import SessionLog
        sl = SessionLog(log)
        if args.list:
            sl.list_sessions()
        elif args.clear:
            sl.clear()
        elif args.session:
            sl.show_session(args.session)
        else:
            sl.tail(args.tail)

    elif args.command == "gui":
        from gui.app import run_gui
        run_gui(host=args.host, port=args.port, open_browser=not args.no_browser)

    elif args.command == "config":
        from core.config import ConfigManager
        cm = ConfigManager(log)
        if args.reset:
            cm.reset()
        elif args.show:
            cm.show()
        elif args.get:
            cm.get(args.get)
        elif args.set:
            for kv in args.set:
                k, _, v = kv.partition("=")
                cm.set(k.strip(), v.strip())


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print()
        print("  \033[1;33m⚡ Interrupted.\033[0m")
        print()
        sys.exit(0)
    except Exception as e:
        print()
        print(f"  \033[1;31m❌ Error: {e}\033[0m")
        if "--verbose" in sys.argv or "-v" in sys.argv:
            import traceback
            traceback.print_exc()
        else:
            print("  \033[2mRun with -v for full traceback.\033[0m")
        print()
        sys.exit(1)
