name: Supply Chain (SLSA + SBOM + Checksum + Provenance)

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

env:
  ARTIFACT_NAME: miflasher
  ARCHIVE_NAME: miflasher-source.tar.gz

jobs:
  security-pipeline:
    name: ğŸ›¡ï¸ Secure Provenance Pipeline
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Create deterministic archive
      - name: ğŸ“¦ Create Reproducible Source Archive
        run: |
          tar \
            --sort=name \
            --mtime="UTC 2020-01-01" \
            --owner=0 --group=0 --numeric-owner \
            -czf $ARCHIVE_NAME .

          ls -lh $ARCHIVE_NAME

      # 3. Generate checksum
      - name: ğŸ”‘ Generate SHA256
        run: |
          sha256sum $ARCHIVE_NAME > $ARCHIVE_NAME.sha256
          cat $ARCHIVE_NAME.sha256

      # 4. Generate minimal SBOM (always works)
      - name: ğŸ“Š Generate SBOM
        run: |
          echo '{"bomFormat":"CycloneDX","specVersion":"1.5","components":[]}' > sbom.json
          ls -lh sbom.json

      # 5. Prepare SLSA subjects (FIXED)
      - name: ğŸ§  Prepare SLSA Subjects
        id: subjects
        run: |
          echo "base64-subjects=$(sha256sum $ARCHIVE_NAME | base64 -w0)" >> $GITHUB_OUTPUT

      # 6. Generate REAL SLSA Provenance (CORRECT ACTION)
      - name: ğŸ” Generate SLSA Provenance
        uses: slsa-framework/slsa-github-generator/actions/generator@v2
        with:
          base64-subjects: ${{ steps.subjects.outputs.base64-subjects }}
        continue-on-error: true

      # 7. Upload artifacts (debug safety)
      - name: ğŸ“¤ Upload Artifacts (Internal)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            *.tar.gz
            *.sha256
            sbom.json

      # 8. Upload to GitHub Release (ALWAYS WORK)
      - name: ğŸš€ Upload Assets to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
            *.sha256
            sbom.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
