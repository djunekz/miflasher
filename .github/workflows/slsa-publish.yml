name: Supply Chain (SLSA + SBOM + Checksum + Provenance)

on:
  release:
    types: [created, published]
  workflow_dispatch:
  push:
    branches: [ master ]

permissions:
  contents: write
  id-token: write
  actions: read

env:
  ARTIFACT_NAME: miflasher
  ARCHIVE_NAME: miflasher-source.tar.gz

jobs:
  hardcore-security-pipeline:
    name: üõ°Ô∏è Build Secure Provenance Pipeline
    runs-on: ubuntu-latest

    steps:
      # ================================
      # 1. CHECKOUT REPOSITORY
      # ================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ================================
      # 2. VALIDATE PROJECT STRUCTURE
      # ================================
      - name: üîé Validate Project Structure
        run: |
          echo "üîç Checking repository structure..."
          ls -la
          echo "Branch: $GITHUB_REF"
          echo "Commit: $GITHUB_SHA"

      # ================================
      # 3. CREATE REPRODUCIBLE SOURCE ARCHIVE
      # ================================
      - name: üì¶ Create Reproducible Source Archive
        run: |
          echo "üì¶ Creating deterministic source archive..."
          tar \
            --sort=name \
            --mtime="UTC 2020-01-01" \
            --owner=0 \
            --group=0 \
            --numeric-owner \
            -czf $ARCHIVE_NAME .

          echo "Archive created:"
          ls -lh $ARCHIVE_NAME

      # ================================
      # 4. GENERATE SHA256 CHECKSUM
      # ================================
      - name: üîë Generate SHA256 Checksum
        run: |
          echo "üîë Generating SHA256 checksum..."
          sha256sum $ARCHIVE_NAME | tee $ARCHIVE_NAME.sha256
          cat $ARCHIVE_NAME.sha256

      # ================================
      # 5. INSTALL SBOM TOOL (CycloneDX)
      # ================================
      - name: üßæ Install SBOM Tools
        run: |
          echo "üßæ Installing CycloneDX tools..."
          pip install cyclonedx-bom || true

      # ================================
      # 6. GENERATE SBOM (Software Bill of Materials)
      # ================================
      - name: üìä Generate SBOM (CycloneDX)
        continue-on-error: true
        run: |
          echo "üìä Generating SBOM..."
          if [ -f "requirements.txt" ]; then
            cyclonedx-py requirements -o sbom.json || echo "SBOM generation failed (non-critical)"
          else
            echo "{}" > sbom.json
            echo "No requirements.txt found, creating empty SBOM"
          fi

          echo "SBOM file:"
          ls -lh sbom.json

      # ================================
      # 7. PREPARE SLSA SUBJECTS (ANTI EXIT 27 FIX)
      # ================================
      - name: üß† Prepare SLSA Subjects
        run: |
          echo "üß† Preparing SLSA subjects..."
          if [ -f "$ARCHIVE_NAME" ]; then
            sha256sum $ARCHIVE_NAME > subjects.sha256
            echo "Subjects:"
            cat subjects.sha256
          else
            echo "Archive missing!" 
            exit 1
          fi

      # ================================
      # 8. GENERATE SLSA LEVEL 3 PROVENANCE (SECURE)
      # ================================
      - name: üîê Generate SLSA Provenance (Level 3)
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
        with:
          base64-subjects: ${{ steps.prepare-subjects.outputs.base64-subjects || '' }}
        continue-on-error: true

      # ================================
      # 9. UPLOAD BUILD ARTIFACTS (ALWAYS)
      # ================================
      - name: üì§ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hardcore-security-artifacts
          path: |
            *.tar.gz
            *.sha256
            sbom.json
          if-no-files-found: warn

      # ================================
      # 10. ATTACH FILES TO GITHUB RELEASE (AUTO)
      # ================================
      - name: üöÄ Upload Assets to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
            *.sha256
            sbom.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ================================
      # 11. SECURITY SUMMARY REPORT
      # ================================
      - name: üìã Security Summary
        run: |
          echo "================ SECURITY PIPELINE SUMMARY ================"
          echo "Project        : $ARTIFACT_NAME"
          echo "Archive        : $ARCHIVE_NAME"
          echo "Commit         : $GITHUB_SHA"
          echo "Branch         : $GITHUB_REF"
          echo "SBOM Generated : $( [ -f sbom.json ] && echo YES || echo NO )"
          echo "Checksum Ready : $( [ -f $ARCHIVE_NAME.sha256 ] && echo YES || echo NO )"
          echo "Provenance     : ENABLED (SLSA Level 3 Attempted)"
          echo "Security Level : HARDCORE üî•"
          echo "=========================================================="
