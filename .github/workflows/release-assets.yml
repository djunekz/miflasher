name: Build Source + Checksum + SBOM

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [ master ]

permissions:
  contents: write

env:
  ARCHIVE_NAME: miflasher-source.tar.gz

jobs:
  build-artifacts:
    name: ðŸ“¦ Build Clean Release Artifacts
    runs-on: ubuntu-latest

    steps:
      # ==============================
      # 1. Checkout repo (FULL history)
      # ==============================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==============================
      # 2. Show debug info
      # ==============================
      - name: ðŸ”Ž Debug Info
        run: |
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref : $GITHUB_REF"
          echo "SHA : $GITHUB_SHA"
          ls -la

      # ==============================
      # 3. Create CLEAN source archive (ANTI TAR ERROR)
      # ==============================
      - name: ðŸ“¦ Create Deterministic Source Archive (CI SAFE)
        run: |
          set -e
          echo "Creating archive using git archive (NO tar dot)..."

          git archive \
            --format=tar.gz \
            --output="$ARCHIVE_NAME" \
            HEAD

          echo "Archive created successfully:"
          ls -lh "$ARCHIVE_NAME"

      # ==============================
      # 4. Generate SHA256
      # ==============================
      - name: ðŸ”‘ Generate SHA256 Checksum
        run: |
          set -e
          sha256sum "$ARCHIVE_NAME" | tee "$ARCHIVE_NAME.sha256"
          echo "Checksum:"
          cat "$ARCHIVE_NAME.sha256"

      # ==============================
      # 5. Install SBOM tool (optional, no fail)
      # ==============================
      - name: ðŸ§¾ Install SBOM Tool
        continue-on-error: true
        run: |
          pip install cyclonedx-bom || true

      # ==============================
      # 6. Generate SBOM (SAFE, no crash)
      # ==============================
      - name: ðŸ“Š Generate SBOM
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ]; then
            echo "Generating SBOM from requirements.txt"
            cyclonedx-py requirements -o sbom.json || echo "{}" > sbom.json
          else
            echo "{}" > sbom.json
            echo "No requirements.txt, created empty SBOM"
          fi

          ls -lh sbom.json

      # ==============================
      # 7. Upload artifacts (ALWAYS)
      # ==============================
      - name: ðŸ“¤ Upload Artifacts (CI)
        uses: actions/upload-artifact@v4
        with:
          name: miflasher-artifacts
          path: |
            *.tar.gz
            *.sha256
            sbom.json
          if-no-files-found: warn

      # ==============================
      # 8. Upload to GitHub Release (AUTO)
      # ==============================
      - name: ðŸš€ Upload Assets to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
            *.sha256
            sbom.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================
      # 9. Final Summary (biar jelas)
      # ==============================
      - name: ðŸ“‹ Build Summary
        run: |
          echo "=============================="
          echo "BUILD SUCCESS (STABLE MODE)"
          echo "Archive : $ARCHIVE_NAME"
          echo "SHA256  : $(cat $ARCHIVE_NAME.sha256 | cut -d ' ' -f1)"
          echo "SBOM    : $( [ -f sbom.json ] && echo READY || echo EMPTY )"
          echo "No SLSA (anti error & anti exit 27)"
          echo "No tar dot bug"
          echo "=============================="
